{{<layout.html.mustache}}
{{$head}}
<style>
    .form-inline {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .form-inline .provider-wrapper {
        margin: auto 0;
    }

    .form-inline label {
        margin: 0 10px 4px 0;

        font-size: 14px;
        font-style: normal;
        font-weight: 600;
        line-height: 150%; /* 21px */
        letter-spacing: 0.15px;
    }

    .form-inline select, .form-inline input {
        width: 100%;
        height: 40px;

        padding: 0 16px;
        margin: 10px 0;

        border-radius: 8px;
        border: 1px solid #00A88F;
        background: #FFF;

        font-size: 14px;
        font-style: normal;
        font-weight: 600;
        line-height: 150%; /* 21px */
        letter-spacing: 0.15px;
    }

    .form-inline select {
        outline: none;
        font-weight: 400;
    }

    .form-inline input[type=submit] {
        padding: 10px 20px;
        cursor: pointer;
        color: white;

        border-radius: 24px;

        background: #00A88F url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIgogICAgIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICAgIDxkZWZzPgogICAgICAgIDxzdHlsZT4KICAgICAgICAgICAgLmNscy0xIHsKICAgICAgICAgICAgY2xpcC1wYXRoOiB1cmwoI2NsaXBwYXRoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLmNscy01IHsKICAgICAgICAgICAgY2xpcC1wYXRoOiB1cmwoI2NsaXBwYXRoLTEpOwogICAgICAgICAgICB9CiAgICAgICAgPC9zdHlsZT4KICAgICAgICA8Y2xpcFBhdGggaWQ9ImNsaXBwYXRoIj4KICAgICAgICAgICAgPHBhdGggZD0ibTI1Niw0NTQuMDNjLTg5LjA1LDAtMTYxLjUtNzIuNDUtMTYxLjUtMTYxLjV2LTczLjg2YzAtODkuMDUsNzIuNDUtMTYxLjUsMTYxLjUtMTYxLjVzMTYxLjUsNzIuNDUsMTYxLjUsMTYxLjV2NzMuODZjMCw4OS4wNS03Mi40NSwxNjEuNS0xNjEuNSwxNjEuNVptMC0zNzguNTFjLTc4LjkzLDAtMTQzLjE1LDY0LjIyLTE0My4xNSwxNDMuMTV2NzMuODZjMCw3OC45Myw2NC4yMiwxNDMuMTUsMTQzLjE1LDE0My4xNXMxNDMuMTUtNjQuMjEsMTQzLjE1LTE0My4xNXYtNzMuODZjMC03OC45My02NC4yMS0xNDMuMTUtMTQzLjE1LTE0My4xNVptNTguOTYsMTY0LjQyaC0xMDAuMzl2LTE5LjQ0YzAtMjQuNTUsMTkuOTctNDQuNTIsNDQuNTItNDQuNTIsMTYuNDksMCwzMS41Nyw5LjA5LDM5LjM0LDIzLjcxLDMuNzgsNy4wOSwxMi41OCw5Ljc5LDE5LjY4LDYuMDIsNy4xLTMuNzcsOS43OS0xMi41OCw2LjAyLTE5LjY4LTEyLjg0LTI0LjE0LTM3Ljc2LTM5LjE0LTY1LjA0LTM5LjE0LTQwLjU5LDAtNzMuNjIsMzMuMDItNzMuNjIsNzMuNjJ2NzYuMzRjMCwxLjMyLjE5LDIuNi41MiwzLjgyLDMuODIsMzQuNywzMy4yMiw2MS42OSw2OC45NCw2MS42OSwzOS4xNiwwLDcwLjktMzEuNzQsNzAuOS03MC45di00MC42NWMwLTYtNC44Ny0xMC44Ny0xMC44Ny0xMC44N1ptLTQ4LjAzLDY4LjI0Yy0uMDEsNS4yNS00LjQsOS41LTkuNzksOS40OS01LjM5LS4wMS05Ljc2LTQuMjgtOS43NC05LjU0bC4wNi0yMy43OGMuMDEtNS4yNSw0LjQtMTEuOTgsOS44LTExLjk3LDUuMzkuMDEsOS43NSw2Ljc3LDkuNzQsMTIuMDJsLS4wNiwyMy43OFptODEuNjEsNTcuNDFjMy41NS00LjQ5LDYuOC05LjI5LDkuNjctMTQuMjQsMi43OC00LjgyLDEuMTMtMTAuOTgtMy42OC0xMy43Ni00LjgyLTIuNzktMTAuOTgtMS4xMy0xMy43NiwzLjY4LTIuMzgsNC4xMi01LjA4LDguMS04LjAzLDExLjgzLTE4LjcyLDIzLjY4LTQ2LjcsMzcuMjYtNzYuNzQsMzcuMjYtNTIuMzgsMC05Ni4yNS00Mi41Ny05Ny43OS05NC45LS4xNi01LjU2LTQuNzgtOS44Ni0xMC4zNy05Ljc3LTUuNTYuMTYtOS45NCw0LjgtOS43NywxMC4zNy45MSwzMC43MywxMy41OSw1OS41LDM1LjcxLDgxLjAyLDIyLjE3LDIxLjU2LDUxLjM3LDMzLjQ0LDgyLjIyLDMzLjQ0LDM2LjI0LDAsNjkuOTctMTYuMzcsOTIuNTQtNDQuOTFabTI1LjQzLTczLjA2di03My44NmMwLTYzLjU2LTUxLjY4LTExNi40OC0xMTUuMjEtMTE3Ljk1LS45Mi0uMDItMS44NC0uMDMtMi43Ny0uMDMtNS41NiwwLTEwLjA3LDQuNTEtMTAuMDcsMTAuMDdzNC41MSwxMC4wNywxMC4wNywxMC4wN2MuNzcsMCwxLjU0LDAsMi4zLjAzLDUyLjY4LDEuMjIsOTUuNTMsNDUuMSw5NS41Myw5Ny44MXY3My44NmMwLDUuNTYsNC41MSwxMC4wNywxMC4wNywxMC4wN3MxMC4wNy00LjUxLDEwLjA3LTEwLjA3Wm0tMjE1Ljg0LTQ4LjYxdi0yMS4xMWwuMDItNC4xNGMwLTM4LDIyLjM3LTcyLjg4LDU2Ljk5LTg4Ljg2LDUuMDUtMi4zMyw3LjI1LTguMzIsNC45Mi0xMy4zNy0yLjMzLTUuMDUtOC4zMS03LjI1LTEzLjM3LTQuOTItNDEuNzMsMTkuMjctNjguNjksNjEuMzMtNjguNjksMTA3LjA5bC0uMDIsMjUuMzFjMCw1LjU2LDQuNTEsMTAuMDcsMTAuMDcsMTAuMDdzMTAuMDctNC41MSwxMC4wNy0xMC4wN1oiLz4KICAgICAgICA8L2NsaXBQYXRoPgogICAgPC9kZWZzPgogICAgPGcgY2xhc3M9ImNscy0xIj4KICAgICAgICA8ZyBjbGFzcz0iY2xzLTUiPgogICAgICAgICAgICA8cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNjk1IiBoZWlnaHQ9Ijg0OSIgZmlsbD0id2hpdGUiLz4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==) no-repeat 12px 0;
    }

    .form-inline input[type=submit]:hover, .form-inline input[type=submit]:active {
        background-color: rgba(0, 168, 143, 0.92);
    }
</style>
{{/head}}
{{$body}}
<form action="/auth/select-idp" method="post" class="form-inline">
    <div class="provider-wrapper">
        <h1>GesundheitsID</h1>
        <label for="idp-selection">{{#trans}}idp.selection{{/trans}}</label>
        <div class="autocomplete-container">
            <input type="text"
                   id="idp-selection"
                   class="autocomplete-input"
                   placeholder="Type to search providers..."
                   autocomplete="off">
            <input type="hidden" name="identityProvider" id="identity-provider-value">
            <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
        </div>
    </div>
    <input type="submit" value="{{#trans}}idp.login{{/trans}}">
</form><script>
    //TODO -> provided by backend
    const providers = [
        {"url": "https://a.example.com", "name": "AoK Tesfalen"},
        {"url": "https://a.example.com", "name": "AOK Bestfalen"},
        {"url": "https://a.example.com", "name": "AOK Testmark"},
        {"url": "https://a.example.com", "name": "Vereinigte AOK"},
        {"url": "https://a.example.com", "name": "Aotest"},
        {"url": "https://d.example.com", "name": "Barmer"},
        {"url": "https://b.example.com", "name": "Siemens"},
        {"url": "https://c.example.com", "name": "Zuse"},
    ];

    class AutoComplete {
        constructor(inputElement, dropdownElement, hiddenElement, data) {
            this.input = inputElement;
            this.dropdown = dropdownElement;
            this.hidden = hiddenElement;

            this.data = data.map(item => ({...item, tokens: this.tokenize(item.name)}));

            this.filteredData = [];
            this.highlightedIndex = -1;
            this.isOpen = false;

            this.init();
        }

        tokenize(text) {
            return text.toLowerCase().split(' ').map(token => token.trim());
        }

        init() {
            this.input.addEventListener('input', (e) => this.handleInput(e));
            this.input.addEventListener('focus', (e) => this.handleFocus(e));
            this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
            this.input.addEventListener('blur', (e) => this.handleBlur(e));

            // Prevent form submission if no valid selection
            this.input.form.addEventListener('submit', (e) => this.handleSubmit(e));
        }

        handleInput(e) {
            const value = e.target.value.toLowerCase();

            this.filteredData = this.filter(value);

            if (this.filteredData.length > 0 && value.length > 0) {
                this.showDropdown();
            } else {
                this.hideDropdown();
            }

            // Clear hidden input if text doesn't match any provider exactly
            const exactMatch = this.data.find(item =>
                    item.name.toLowerCase() === value
            );
            if (!exactMatch) {
                this.hidden.value = '';
            }
        }

        filter(value) {

            if (!value || value.length === 0) {
                return [];
            }

            const needleTokens = this.tokenize(value);
            if (needleTokens.length === 0) {
                return [];
            }

            return this.data.filter(item => this.matchingTokens(needleTokens, item.tokens));
        }

        matchingTokens(needleTokens, itemTokens) {
            // each search token needs to match at least one of the items tokens
            for (let needle of needleTokens) {
                let found = false;
                for (let token of itemTokens) {
                    if (token.startsWith(needle)) {
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    return false;
                }
            }
            return true;
        }

        handleFocus(e) {
            if (this.input.value.length > 0) {
                this.handleInput(e);
            }
        }

        handleKeydown(e) {
            if (!this.isOpen) return;

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    this.highlightedIndex = Math.min(
                            this.highlightedIndex + 1,
                            this.filteredData.length - 1
                    );
                    this.updateHighlight();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.highlightedIndex = Math.max(this.highlightedIndex - 1, -1);
                    this.updateHighlight();
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (this.highlightedIndex >= 0) {
                        this.selectItem(this.filteredData[this.highlightedIndex]);
                    }
                    break;
                case 'Escape':
                    this.hideDropdown();
                    this.input.blur();
                    break;
            }
        }

        handleBlur(e) {
            // Delay hiding to allow for clicks on dropdown items
            setTimeout(() => {
                this.hideDropdown();
            }, 150);
        }

        handleSubmit(e) {
            if (!this.hidden.value) {
                e.preventDefault();
                alert('Please select a valid GesundheitsID Provider');
                this.input.focus();
            }
        }

        showDropdown() {
            this.dropdown.innerHTML = '';
            this.highlightedIndex = -1;

            this.filteredData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = item.name;
                div.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // Prevent blur event
                    this.selectItem(item);
                });
                div.addEventListener('mouseenter', () => {
                    this.highlightedIndex = index;
                    this.updateHighlight();
                });
                this.dropdown.appendChild(div);
            });

            this.dropdown.style.display = 'block';
            this.isOpen = true;
        }

        hideDropdown() {
            this.dropdown.style.display = 'none';
            this.isOpen = false;
            this.highlightedIndex = -1;
        }

        updateHighlight() {
            const items = this.dropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === this.highlightedIndex);
            });
        }

        selectItem(item) {
            this.input.value = item.name;
            this.hidden.value = item.url;
            this.hideDropdown();

            // Add visual feedback for selection
            const items = this.dropdown.querySelectorAll('.autocomplete-item');
            items.forEach(el => el.classList.remove('selected'));
        }
    }

    // Initialize autocomplete when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        const inputElement = document.getElementById('idp-selection');
        const dropdownElement = document.getElementById('autocomplete-dropdown');
        const hiddenElement = document.getElementById('identity-provider-value');

        new AutoComplete(inputElement, dropdownElement, hiddenElement, providers);
    });
</script>
{{/body}}
{{/layout.html.mustache}}
