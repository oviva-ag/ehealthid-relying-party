package com.oviva.ehealthid.fedclient.api;

import static org.junit.jupiter.api.Assertions.*;

import java.time.Instant;
import org.junit.jupiter.api.Test;

class ExtendedJWKSetJWSTest {

  @Test
  void parse() {

    var eJwks =
        ExtendedJWKSetJWS.parse(
            """
        eyJraWQiOiJqd3RzaWduZXItMjAyNCIsInR5cCI6Imp3ay1zZXQranNvbiIsImFsZyI6IkVTMjU2In0.eyJpc3MiOiJodHRwczovL2lkYnJva2VyLnRrLmVoZWFsdGgtaWQuZGUiLCJleHAiOjE3MjkyNTY5NzUsImlhdCI6MTcyOTE3MDU3NSwia2V5cyI6W3sia3R5IjoiRUMiLCJ4NXQjUzI1NiI6IjNZNHU1TS1IMGJtSE5GTjdqZER3V3NrNktsU01tOFUtbUEzMXM1Szg4OVEiLCJuYmYiOjE3MDc4MTU1MDQsInVzZSI6InNpZyIsImNydiI6IlAtMjU2Iiwia2lkIjoiand0c2lnbmVyLTIwMjQiLCJ4NWMiOlsiTUlJQi9qQ0NBYU9nQXdJQkFnSUVTSXlhSmpBTUJnZ3Foa2pPUFFRREFnVUFNSFF4Q3pBSkJnTlZCQWdUQWtKWE1SRXdEd1lEVlFRSEV3aEZhRzVwYm1kbGJqRUxNQWtHQTFVRUJoTUNSRVV4RERBS0JnTlZCQW9UQTBsQ1RURVlNQllHQTFVRUN4TVBVMlZyU1VSUUlGQnliMlFnVkVWRk1SMHdHd1lEVlFRREV4UktWMVJUYVdkdVpYSXRNakF5TkNCUVZTQlVTekFlRncweU5EQXlNVE13T1RFeE5EUmFGdzB5TlRBek1UY3dPVEV4TkRSYU1IUXhDekFKQmdOVkJBZ1RBa0pYTVJFd0R3WURWUVFIRXdoRmFHNXBibWRsYmpFTE1Ba0dBMVVFQmhNQ1JFVXhEREFLQmdOVkJBb1RBMGxDVFRFWU1CWUdBMVVFQ3hNUFUyVnJTVVJRSUZCeWIyUWdWRVZGTVIwd0d3WURWUVFERXhSS1YxUlRhV2R1WlhJdE1qQXlOQ0JRVlNCVVN6QlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJJOUJQNUdaOG1hMG5GQUMySE1jQTVDWnhsWkFodHVGY2xpaEk2Vm5KVXVzZjBBN1hhVWpicktYNDJsbVJ5ci9seWpuWFBYQktWd0p0UWJlcUxFVGZYeWpJVEFmTUIwR0ExVWREZ1FXQkJSTDNxZUpFWU51T2tmUmhubmtHbTMySFl6Uml6QU1CZ2dxaGtqT1BRUURBZ1VBQTBjQU1FUUNJQ2JPQldyTGlNSGduT2tNZjJSWWduTXVmZitKWnZqWXVCRjZiRVlja1pOQ0FpQlF1SmhZaTl0cXJrVkJNZjhRVFdacUI5K2hBM2lvQ3dXTzFTNFM2S2RSZVE9PSJdLCJ4IjoiajBFX2tabnlaclNjVUFMWWN4d0RrSm5HVmtDRzI0VnlXS0VqcFdjbFM2dyIsInkiOiJmMEE3WGFVamJyS1g0MmxtUnlyX2x5am5YUFhCS1Z3SnRRYmVxTEVUZlh3IiwiZXhwIjoxNzQyMjAyNzA0LCJhbGciOiJFUzI1NiJ9LHsia3R5IjoiRUMiLCJ4NXQjUzI1NiI6IkFPd1E1QTl6N1drRF96X2FXUVI1Um9RdlRyUGdLNVlFQnZDNVB2UjRzR3MiLCJuYmYiOjE3MDc4MTU1NzMsInVzZSI6InNpZyIsImNydiI6IlAtMjU2Iiwia2lkIjoidG9rZW5zaWduZXItMjAyNCIsIng1YyI6WyJNSUlDQWpDQ0FhZWdBd0lCQWdJRU5hUm1TekFNQmdncWhrak9QUVFEQWdVQU1IWXhDekFKQmdOVkJBZ1RBa0pYTVJFd0R3WURWUVFIRXdoRmFHNXBibWRsYmpFTE1Ba0dBMVVFQmhNQ1JFVXhEREFLQmdOVkJBb1RBMGxDVFRFWU1CWUdBMVVFQ3hNUFUyVnJTVVJRSUZCeWIyUWdWRVZGTVI4d0hRWURWUVFERXhaVWIydGxibE5wWjI1bGNpMHlNREkwSUZCVklGUkxNQjRYRFRJME1ESXhNekE1TVRJMU0xb1hEVEkxTURNeE56QTVNVEkxTTFvd2RqRUxNQWtHQTFVRUNCTUNRbGN4RVRBUEJnTlZCQWNUQ0VWb2JtbHVaMlZ1TVFzd0NRWURWUVFHRXdKRVJURU1NQW9HQTFVRUNoTURTVUpOTVJnd0ZnWURWUVFMRXc5VFpXdEpSRkFnVUhKdlpDQlVSVVV4SHpBZEJnTlZCQU1URmxSdmEyVnVVMmxuYm1WeUxUSXdNalFnVUZVZ1ZFc3dXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CQndOQ0FBU3BzLzU0MWRvb3hHVVg0dTM2bmYwbU5KSFhVc3JNT2FneFA2clZFdmtoY3RjUE5DUGJ2MjdGaS9UZE1COFVzSDM3ZUxUOElxanAreXMrTnpCQnV2bkNveUV3SHpBZEJnTlZIUTRFRmdRVUJRN3VncmhWa0pDYzBqdjVNRTlPanR6U3Evd3dEQVlJS29aSXpqMEVBd0lGQUFOSEFEQkVBaUJDTmJFeEtWMVROa2Y0bGVNOU43RzJWMFBHeVVpUzE5RkI1QXpqb0d4UndnSWdCdUgwK2RTMjN1WUtsV0R2ZUpLM2VPdkVpZDFyN0VHTDkrYWNSQVFUUCtZPSJdLCJ4IjoicWJQLWVOWGFLTVJsRi1MdC1wMzlKalNSMTFMS3pEbW9NVC1xMVJMNUlYSSIsInkiOiIxdzgwSTl1X2JzV0w5TjB3SHhTd2ZmdDR0UHdpcU9uN0t6NDNNRUc2LWNJIiwiZXhwIjoxNzQyMjAyNzczLCJhbGciOiJFUzI1NiJ9XX0.PN4Oo4x9GKuj4MjARDRj7zTv_xa094UpuuI9VSG1pGCS3DNFJuARw-8nPQLwYKSIkImGVXim5N2ZJyohQX3Zsg
        """);

    assertTrue(eJwks.isValidAt(Instant.ofEpochSecond(1729256000L)));
    assertEquals("https://idbroker.tk.ehealth-id.de", eJwks.body().iss());
    assertEquals(2, eJwks.body().toJWKSet().size());
  }

  @Test
  void parseWithoutTypHeader() {
    var raw =
        """
        eyJraWQiOiIwMDAxMDAwMTEwNzIwMjc5MzAwMDIiLCJhbGciOiJFUzI1NiJ9.eyJpc3MiOiJodHRwczovL3d3dy5pZHAuaWFtLWJtcy5kZS8xMDcyMDI3OTMiLCJpYXQiOjE3NDMzMTQyMjcsImV4cCI6MTc0MzQwMDYyNywia2V5cyI6W3sia3R5IjoiRUMiLCJ1c2UiOiJzaWciLCJjcnYiOiJQLTI1NiIsImtpZCI6IjAwMDEwMDAxMTA3MjAyNzkzMDAwMSIsIngiOiJqQzA5VFZrd05PQnlaSXhsclVNajdwaVVkRXd4bDRDb2xGV2dram1GVFRFIiwieSI6IngzM2s3cE5pRHNjQXV3UkdyT2dQalYtVnBTZ005aFFkODR3OEpJMnpIcTAiLCJleHAiOjEuNzM1Njg5NkU5LCJhbGciOiJFUzI1NiJ9LHsia3R5IjoiRUMiLCJ1c2UiOiJzaWciLCJjcnYiOiJQLTI1NiIsImtpZCI6IjAwMDEwMDAxMTA3MjAyNzkzMDAwMiIsIngiOiJ6WUZiRTljMXp5OW5vZHAxdlc5YlEyZUtlQ1p1N2I3VTM5SE9OQmY2Ni1FIiwieSI6InRmcktxYlpsUDdkMVhBRmMtMGR1UHdiLU5mV2dIbVNta0VRdVdaeS1JVFEiLCJleHAiOjEuNzY2NTM0NEU5LCJhbGciOiJFUzI1NiJ9LHsia3R5IjoiRUMiLCJ1c2UiOiJzaWciLCJjcnYiOiJQLTI1NiIsImtpZCI6IjAwMDIwMDAxMTA3MjAyNzkzMDAwMiIsIng1YyI6WyJNSUlDelRDQ0FuT2dBd0lCQWdJREFOdk9NQW9HQ0NxR1NNNDlCQU1DTUc4eEN6QUpCZ05WQkFZVEFrUkZNUlV3RXdZRFZRUUtEQXhuWlcxaGRHbHJJRWR0WWtneE1qQXdCZ05WQkFzTUtVdHZiWEJ2Ym1WdWRHVnVMVU5CSUdSbGNpQlVaV3hsYldGMGFXdHBibVp5WVhOMGNuVnJkSFZ5TVJVd0V3WURWUVFEREF4SFJVMHVTMDlOVUMxRFFUZ3dIaGNOTWpReE1USXhNVE16TmpReldoY05Namt4TVRJd01UTXpOalF5V2pCdU1Rc3dDUVlEVlFRR0V3SkVSVEVlTUJ3R0ExVUVDZ3dWUWtsVVRVRlNRMHNnVTJWeWRtbGpaU0JIYldKSU1Ta3dKd1lEVlFRRkV5QTJNRFkzTlMxV01ERkpNREF3TWxReU1ESTBNVEV5TVRFek16TXpOVEF3T1RFVU1CSUdBMVVFQXd3TFNVdExJR05zWVhOemFXTXdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CQndOQ0FBVHQrWWZYM1lSU3lCa1lpNVJnTFZrUXljalJhY0NweW9hcjRQaTFoNVF6YTJIcngxUGZpTXY1ZWFvaUVWZnpYcmM0blpLeHkvZlVtVlp5QzFidnRYWmtvNEgrTUlIN01CMEdBMVVkRGdRV0JCUm9kUWcrdmRwVDVsMU13RlViWDdtcDJzVlZOREFmQmdOVkhTTUVHREFXZ0JUNGJ1REpnbnk2aEhjUEJzTmFvZnhVS1luL1FEQkZCZ2dyQmdFRkJRY0JBUVE1TURjd05RWUlLd1lCQlFVSE1BR0dLV2gwZEhBNkx5OWtiM2R1Ykc5aFpDNWpjbXd1ZEdrdFpHbGxibk4wWlM1a1pTOXZZM053TDJWak1BNEdBMVVkRHdFQi93UUVBd0lIZ0RBaEJnTlZIU0FFR2pBWU1Bb0dDQ3FDRkFCTUJJRWpNQW9HQ0NxQ0ZBQk1CSUZMTUF3R0ExVWRFd0VCL3dRQ01BQXdNUVlGS3lRSUF3TUVLREFtTUNRd0lqQWdNQjR3RUF3T2MyVnJkRzl5WVd4bGNpQkpSRkF3Q2dZSUtvSVVBRXdFZ2pNd0NnWUlLb1pJemowRUF3SURTQUF3UlFJZ1dsenUwMkxDbmt5UWhTSlh6QTFNSEhoM3JtNm1TMERhZmZOcWM3MTgyTDhDSVFDQU9PVHM2ZlJGTm9HSUhFSzZlMUhja3VKL21qODcrb0dpU3hjTlBEYlozQT09Il0sIngiOiJBTzM1aDlmZGhGTElHUmlMbEdBdFdSREp5TkZwd0tuS2hxdmctTFdIbEROciIsInkiOiJZZXZIVTktSXlfbDVxaUlSVl9OZXR6aWRrckhMOTlTWlZuSUxWdS0xZG1RIiwiZXhwIjoxLjg4OTg3NjIwMkU5LCJhbGciOiJFUzI1NiJ9XX0.YlTYEhRqpJr9cFvZ-ULY7Go1Jl9ONUoq-H-hm1vyiG5SSKuhYMElESulIt505krOG3ATOj6u6Nt9G6Nl6WAg_A
        """;

    var eJwks = ExtendedJWKSetJWS.parse(raw);
    assertTrue(eJwks.isValidAt(Instant.ofEpochSecond(1743400000L)));
    assertEquals("https://www.idp.iam-bms.de/107202793", eJwks.body().iss());
    assertEquals(3, eJwks.body().toJWKSet().size());
  }
}
